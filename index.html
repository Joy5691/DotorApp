<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Doctor Appointment — Demo</title>
<style>
:root {
  --bg: #f4f6f8;
  --card: #fff;
  --muted: #9aa4ad;
  --accent: #2f9e44;
  --danger: #e74c3c;
  --outline: #d8dde3;
  --badge1: #e9f5ff;
  --badge2: #fff3bf;
  --badge3: #f3d9fa;
  --avatar1: #c3fae8;
  --avatar2: #d0ebff;
  --avatar3: #ffd6a5;
  --badge-text1: #228be6;
  --badge-text2: #f59f00;
  --badge-text3: #b197fc;
}
* {box-sizing: border-box;}
body {
  margin: 0;
  font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
  background: var(--bg);
  color: #1f2933;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
.app {
  max-width: 420px;
  margin: 20px auto;
  min-height: 600px;
  padding-bottom: 40px;
}
.screen {
  background: var(--card);
  border-radius: 14px;
  box-shadow: 0 8px 22px rgba(18,26,34,0.06);
  padding: 16px;
  margin-bottom: 18px;
  display: none;
  border: 1px solid var(--outline);
}
.screen.active { display: block; }
.topbar { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
h1 { font-size: 20px; margin: 0; }
.muted { color: var(--muted); font-size: 13px; }
input, textarea, select {
  width: 100%;
  padding: 10px 12px;
  margin-top: 8px;
  border-radius: 10px;
  border: 1px solid var(--outline);
  background: #fff;
  font-size: 14px;
}
input:focus, textarea:focus, button:focus { outline: 2px solid var(--accent) !important;}
label { display: block; margin-top: 12px; font-weight: 600; font-size: 13px;}
.error { color: var(--danger); font-size: 12px; margin-top: 6px;}
button {
  display: inline-block;
  padding: 10px 12px;
  border-radius: 10px;
  border: none;
  background: var(--accent);
  color: white;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
  transition: box-shadow .15s;
}
button.ghost{
  background: transparent;
  color: var(--accent);
  border: 1px solid var(--accent);
}
button.small{padding:6px 8px; font-size:13px}
button.danger{background:var(--danger)}
button:focus{box-shadow:0 0 0 2px var(--accent);}
.badge {
  display: inline-block;
  font-size: 12px;
  font-weight: 600;
  border-radius: 8px;
  padding: 3px 10px;
  margin-right: 4px;
  margin-top: 3px;
}
.child-badge { background: var(--badge1); color: var(--badge-text1);}
.ortho-badge { background: var(--badge2); color: var(--badge-text2);}
.general-badge { background: var(--badge3); color: var(--badge-text3);}
.doctor-card {
  display: flex;
  gap: 12px;
  align-items: flex-start;
  padding: 12px;
  border-radius: 12px;
  background: linear-gradient(180deg,#fff,#fbfdff);
  border: 1px dashed var(--outline);
  margin-top: 12px;
}
.doc-photo {
  width: 60px; height: 60px; border-radius: 10px;
  background: var(--avatar1);
  flex: none;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; font-weight:800; color:#124662;
  margin-right:5px;
  object-fit: cover;
}
.img-av1{background:var(--avatar1);}
.img-av2{background:var(--avatar2);}
.img-av3{background:var(--avatar3);}
.doc-info{flex:1;}
.doc-name{font-weight:700; font-size:16px; margin-bottom:3px;}
.doc-degrees{color: var(--muted); font-size:13px; margin-bottom: 4px;}
.doc-row {font-size:13px;}
.doc-hospital {color: var(--accent); font-weight: 600;}
.doc-exp {color: var(--muted);}
.doc-rating {margin-left: 4px;}
.doc-fee {font-weight:700; color: #228be6; margin-left:3px;}
.actions {display:flex;gap:8px;margin-top:10px;}
footer {font-size:12px;color:var(--muted); margin-top:6px; text-align:center;}
.searchbar{
  display:flex; gap:7px; flex-wrap: wrap; align-items: center; margin-top:12px;
}
.searchbar input{flex:1; min-width: 110px;}
.searchbar select {min-width: 96px; font-size:13px;}
.selectGroup{ display: flex; gap: 7px; flex-wrap: wrap;}
.small-muted{color:var(--muted);font-size:12px;margin-top:8px}
.link{color:var(--accent); cursor:pointer; text-decoration:underline; font-size:13px}
.appointments-list{margin-top:10px}
.appt-item{
  padding:10px;border-radius:10px;border:1px dashed var(--outline);
  margin-bottom:8px;background:#fff;
}
.appt-doc-card {display: flex; gap: 10px; align-items: center; margin-bottom: 6px;}
.appt-doc-photo {width: 46px; height: 46px; border-radius: 8px; font-weight:800; font-size:15px; display:flex;align-items:center;justify-content:center;}
.appt-info {flex:1;}
.appt-meta {font-size:12px; color: var(--muted);}
.appt-fee {color: var(--accent); font-size:14px; font-weight:700;}
.appt-badge {font-size:11px;}
.calendar {
  margin-top:12px;
  border-radius:10px;
  border:1px dashed var(--outline);
  padding:10px;
  background:#fff;
}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px;}
.cal-day{
  padding:8px;border-radius:8px;text-align:center;font-size:13px;border:1px solid transparent;
  background:#fbfdff;color:#222;cursor:pointer;
  transition: background .13s;
}
.cal-day.disabled{opacity:0.38;cursor:default}
.cal-day.selected{background:var(--accent);color:white}
.cal-day.off {background: #fae1e1 !important; color: #e8590c !important; pointer-events:none; opacity:0.45; cursor:not-allowed; border:1px solid #f03e3e;}
.times {display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;}
.slot {
  padding:8px 10px; border-radius:8px; border:1px dashed var(--outline);
  background:#fff; cursor:pointer; font-size:13px;
  transition: background .13s;
}
.slot.taken{opacity:0.4; cursor:default; text-decoration:line-through; background: #fdebd3;}
.slot.break{background:#ffebeb;color:#c92a2a; border-color:#faa2a2; text-decoration:line-through;}
.slot.selected{background:var(--accent); color:white; border:none}
@media (max-width:420px){
  .app{margin:8px}
  .doc-photo{width:48px;height:48px;}
  .appt-doc-photo{width:33px; height:33px; font-size:13px;}
}
</style>
</head>
<body>
<div class="app">

  <!-- PUBLIC DASHBOARD -->
  <div id="publicDashboard" class="screen active">
    <div class="topbar">
      <h1>Doctors</h1>
      <div>
        <span class="muted">Guest</span>
        <button class="small ghost" onclick="showScreen('loginScreen')">Login</button>
      </div>
    </div>
    <div class="searchbar" id="filterBar">
      <input type="text" id="publicSearch" placeholder="Search doctor, specialty..." oninput="renderDoctorList()" />
      <select id="filterSpecialty" onchange="renderDoctorList()">
        <option value="">All Specialties</option>
      </select>
      <select id="filterHospital" onchange="renderDoctorList()">
        <option value="">All Hospitals</option>
      </select>
      <select id="sortDoctor" onchange="renderDoctorList()">
        <option value="">Sort by</option>
        <option value="fee">Fee Low→High</option>
        <option value="exp">Experience High→Low</option>
        <option value="rating">Rating High→Low</option>
      </select>
      <button class="small" onclick="renderDoctorList()">Search</button>
    </div>
    <div id="doctorListPublic"></div>
    <footer>Demo wireframe · card style · click "Appointment" to start</footer>
  </div>

  <!-- LOGIN -->
  <div id="loginScreen" class="screen">
    <div class="topbar">
      <h1>Login</h1>
      <div class="right"><button class="small ghost" onclick="showScreen('publicDashboard')">Cancel</button></div>
    </div>
    <form id="loginForm" onsubmit="event.preventDefault(); login();">
      <label for="loginEmail">Email</label>
      <input id="loginEmail" type="email" placeholder="you@example.com" autocomplete="email" />
      <span class="error" id="loginEmailErr"></span>
      <label for="loginPassword">Password</label>
      <input id="loginPassword" type="password" placeholder="password" autocomplete="current-password" />
      <span class="error" id="loginPassErr"></span>
      <div class="row" style="margin-top:12px">
        <button type="submit">Login</button>
        <div class="space"></div>
        <div class="muted small-muted">No account? <span class="link" onclick="showScreen('registerScreen')">Register</span></div>
      </div>
    </form>
  </div>

  <!-- REGISTER -->
  <div id="registerScreen" class="screen">
    <div class="topbar">
      <h1>Register</h1>
      <div class="right"><button class="small ghost" onclick="showScreen('publicDashboard')">Cancel</button></div>
    </div>
    <form id="registerForm" onsubmit="event.preventDefault(); register();">
      <label>Name</label>
      <input id="regName" type="text" placeholder="Full name" autocomplete="name"/>
      <span class="error" id="regNameErr"></span>
      <label>Email</label>
      <input id="regEmail" type="email" placeholder="you@example.com" autocomplete="email"/>
      <span class="error" id="regEmailErr"></span>
      <label>Phone</label>
      <input id="regPhone" type="text" placeholder="Phone number (digits only)" autocomplete="tel"/>
      <span class="error" id="regPhoneErr"></span>
      <label>Date of birth</label>
      <input id="regDob" type="date" />
      <span class="error" id="regDobErr"></span>
      <label>Password</label>
      <input id="regPass" type="password" />
      <span class="error" id="regPassErr"></span>
      <label>Re-enter password</label>
      <input id="regPass2" type="password" />
      <span class="error" id="regPass2Err"></span>
      <div style="margin-top:12px">
        <button type="submit">Create account</button>
        <button type="button" class="small ghost" onclick="showScreen('loginScreen')">Already have account</button>
      </div>
    </form>
  </div>

  <!-- USER DASHBOARD -->
  <div id="userDashboard" class="screen">
    <div class="topbar">
      <h1>Dashboard</h1>
      <div>
        <span id="dashUserName" class="muted">User</span>
        <button class="small ghost" onclick="logout()">Logout</button>
      </div>
    </div>
    <div class="card" id="patientCard">
      <div style="display:flex; gap:12px; align-items:center">
        <div class="doc-photo img-av1" style="width:48px;height:48px; font-size:14px;">YOU</div>
        <div>
          <div style="font-weight:700" id="userNameShow">Name</div>
          <div class="muted" id="userEmailShow">email</div>
          <div class="muted" id="userPhoneShow"></div>
          <div class="muted" id="userDobShow">DOB</div>
        </div>
      </div>
      <div class="small-muted">Your profile. Appointments below.</div>
    </div>
    <div style="margin-top:12px">
      <label>Search doctors</label>
      <div class="searchbar" id="dashboardFilters"></div>
    </div>
    <div id="doctorListUser"></div>
    <div style="margin-top:12px">
      <h3 style="margin:0">Your Appointment History</h3>
      <div id="appointmentsList" class="appointments-list"></div>
      <div class="small-muted" style="margin-top:8px">
        Book same doctor repeatedly, fee reduces. "Test report only" visit reduces fee by 70%.<br>
        <span style="color:#e8590c; font-weight:600">Red-marked slots are breaks/off-days — cannot be booked.</span>
      </div>
    </div>
  </div>

  <!-- BOOKING SCREEN -->
  <div id="bookingScreen" class="screen">
    <div class="topbar">
      <h1 id="bookingTitle">Book</h1>
      <div class="right"><button class="small ghost" onclick="cancelBooking()">Back</button></div>
    </div>
    <div class="card" id="bookingDocBox"></div>
    <div style="margin-top:10px">
      <label>Select date</label>
      <div class="calendar" id="miniCalendar">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <button class="small ghost" onclick="calPrev()">◀</button>
          <div id="calTitle" style="font-weight:700"></div>
          <button class="small ghost" onclick="calNext()">▶</button>
        </div>
        <div class="cal-grid" id="calGrid"></div>
      </div>
      <div style="margin-top:10px">
        <label>Available time slots (5:00PM – 10:00PM, 15-min)</label>
        <div id="timeSlots" class="times"></div>
        <div class="small-muted">Red = Unavailable due to weekly off/breaks</div>
      </div>
    </div>
    <div id="patientFormWrap" class="card" style="display:none">
      <h3 style="margin:6px 0">Patient details</h3>
      <label><input id="isPatientYou" type="checkbox" onchange="togglePatientSelf()" /> I'm the patient</label>
      <label>Name</label>
      <input id="patientName" type="text" placeholder="Patient full name" />
      <span class="error" id="errPatientName"></span>
      <label>Relation (if not you)</label>
      <input id="patientRelation" type="text" placeholder="e.g. Father, Daughter, Self" />
      <span class="error" id="errPatientRelation"></span>
      <label>Phone</label>
      <input id="patientPhone" type="text" placeholder="Phone number" />
      <span class="error" id="errPatientPhone"></span>
      <label>
        <input type="checkbox" id="showReportsOnly" onchange="updateFeeDisplay()" />
        This visit is only for showing test reports
      </label>
      <div id="selectedFeeDisplay" class="small-muted" style="font-weight:600; margin-top:6px;"></div>
      <div style="display:flex; gap:8px; margin-top:12px">
        <button onclick="confirmBooking()">Confirm booking</button>
        <button class="small ghost" onclick="cancelPatientForm()">Cancel</button>
      </div>
    </div>
  </div>
</div>
<script>
// ---- Sample Doctor Data ----
const doctors = [
  {
    id: "d1",
    name: "Dr. Mithun Sarker",
    degrees: "MBBS, BCS (Health), DCH (Pediatrics)",
    specialties: ["Child Specialist"],
    hospital: "Shaheed Suhrawardy Medical College Hospital",
    rating: 5.0, ratingsCount: 2309, experienceYears: 11, fee: 400,
    offDay: 6, // Saturday
    breaks: [{start:"19:00",end:"19:30"},{start:"21:00",end:"21:30"}]
  },
  {
    id: "d2",
    name: "Dr. Mamunur Rashid",
    degrees: "MBBS, BCS (Health), MS (Ortho), FCPS (Surgery), FRCS (UK)",
    specialties: ["Orthopedist","General Physician"],
    hospital: "Kurmitola General Hospital, Dhaka Cantonment",
    rating: 5.0, ratingsCount: 106, experienceYears: 12, fee: 400, oldFee: 1000,
    offDay: 2, // Tuesday
    breaks: [{start:"18:15",end:"18:45"},{start:"20:30",end:"21:00"}]
  },
  {
    id: "d3",
    name: "Dr. Rima Roy",
    degrees: "MBBS, FCPS (Dermatology)",
    specialties: ["Dermatologist"],
    hospital: "Dhaka Medical College Hospital",
    rating: 4.8, ratingsCount: 841, experienceYears: 9, fee: 500,
    offDay: 4, // Thursday
    breaks: [{start:"17:45",end:"18:15"},{start:"20:00",end:"20:30"}]
  },
  {
    id: "d4",
    name: "Dr. Arif Mostafa",
    degrees: "MBBS, MD (Cardiology)",
    specialties: ["Cardiologist"],
    hospital: "Bangabandhu Sheikh Mujib Medical University",
    rating: 4.9, ratingsCount: 524, experienceYears: 15, fee: 600,
    offDay: 0, // Sunday
    breaks: [{start:"18:00",end:"18:30"},{start:"20:30",end:"21:00"}]
  },
  {
    id: "d5",
    name: "Dr. Shireen Akter",
    degrees: "MBBS, DGO, FCPS (Gynecology)",
    specialties: ["Gynecologist"],
    hospital: "National Institute of Cancer Research",
    rating: 4.7, ratingsCount: 391, experienceYears: 13, fee: 450,
    offDay: 1, // Monday
    breaks: [{start:"19:30",end:"20:00"},{start:"21:15",end:"21:45"}]
  },
  {
    id: "d6",
    name: "Dr. S.M. Azad",
    degrees: "MBBS, MS (Neuro Surgery)",
    specialties: ["Neurosurgeon"],
    hospital: "Central Hospital",
    rating: 4.6, ratingsCount: 267, experienceYears: 10, fee: 700,
    offDay: 5, // Friday
    breaks: [{start:"18:45",end:"19:15"},{start:"20:45",end:"21:15"}]
  }
];
const avatarClass = ["img-av1", "img-av2", "img-av3"];
function docInitials(name){
  let initials = name.split(' ').map(x=>x[0]).join('').toUpperCase();
  if(initials.length>2) return initials.slice(0,2);
  return initials;
}
function docAvatar(index, name){
  return `<div class="doc-photo ${avatarClass[index%3]}">${docInitials(name)}</div>`;
}
function badgeFor(spec) {
  if(/child/i.test(spec)) return 'child-badge';
  if(/ortho/i.test(spec)) return 'ortho-badge';
  if(/general/i.test(spec)) return 'general-badge';
  if(/cardio/i.test(spec)) return 'child-badge';
  if(/gyne/i.test(spec)) return 'ortho-badge';
  if(/neuro/i.test(spec)) return 'general-badge';
  if(/derma/i.test(spec)) return 'child-badge';
  return 'child-badge';
}

let appointments = JSON.parse(localStorage.getItem("appointments")||"[]");
let demoUsers = JSON.parse(localStorage.getItem("demoUsers")||"[]");
let currentUser = null;
let intendedDoctor = null;
let bookingState = {doctorId: null, selectedDate: null, selectedTime: null};
const today = new Date();
let calStart = new Date(today);

// Filter option fill
function fillDoctorFilters(){
  const specialtySet = new Set();
  const hospitalSet = new Set();
  doctors.forEach(doc=>{
    doc.specialties.forEach(s=>specialtySet.add(s));
    hospitalSet.add(doc.hospital);
  });
  const specSelect = document.getElementById('filterSpecialty');
  const hospSelect = document.getElementById('filterHospital');
  specSelect.innerHTML = `<option value="">All Specialties</option>` +
    Array.from(specialtySet).map(s=>`<option>${s}</option>`).join('');
  hospSelect.innerHTML = `<option value="">All Hospitals</option>` +
    Array.from(hospitalSet).map(h=>`<option>${h}</option>`).join('');
  let dashboardBar = document.getElementById('dashboardFilters');
  dashboardBar.innerHTML = `
    <input type="text" id="userSearch" placeholder="Search doctor, specialty..." oninput="renderDoctorList(true)" />
    <select id="dashboardSpecialty" onchange="renderDoctorList(true)">
      <option value="">Specialty</option>
      ${Array.from(specialtySet).map(s=>`<option>${s}</option>`).join('')}
    </select>
    <select id="dashboardHospital" onchange="renderDoctorList(true)">
      <option value="">Hospital</option>
      ${Array.from(hospitalSet).map(h=>`<option>${h}</option>`).join('')}
    </select>
    <select id="dashboardSort" onchange="renderDoctorList(true)">
      <option value="">Sort</option>
      <option value="fee">Fee Low→High</option>
      <option value="exp">Experience High→Low</option>
      <option value="rating">Rating High→Low</option>
    </select>
    <button class="small" onclick="renderDoctorList(true)">Search</button>
  `;
}
fillDoctorFilters();

function fmtDateISO(d){ const y=d.getFullYear(), m=(d.getMonth()+1).toString().padStart(2,'0'), day=d.getDate().toString().padStart(2,'0'); return `${y}-${m}-${day}`;}
function fmtDateNice(iso){ const d=new Date(iso); return d.toLocaleDateString();}
function timeToMinutes(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
function minutesToTime(min){ const h=Math.floor(min/60); const m=min%60; return `${String(h).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`; }
function shortTime(t){ const [hh,mm]=t.split(':').map(Number); const d=new Date(); d.setHours(hh,mm); return d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});}
function getDoctorFee(id) { const doc = doctors.find(doc=>doc.id===id); return doc ? doc.fee : 400;}
function getDoctorById(id) { return doctors.find(doc=>doc.id===id) || {}; }
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
}
// ---- Doctor list ----
function renderDoctorList(userView=false){
  let searchVal = userView ? (document.getElementById('userSearch')||{}).value||"" : document.getElementById('publicSearch').value||"";
  searchVal = searchVal.toLowerCase().trim();
  let specialtyVal = userView ? (document.getElementById('dashboardSpecialty')||{}).value||"" : document.getElementById('filterSpecialty').value||"";
  let hospVal = userView ? (document.getElementById('dashboardHospital')||{}).value||"" : document.getElementById('filterHospital').value||"";
  let sortVal = userView ? (document.getElementById('dashboardSort')||{}).value||"" : document.getElementById('sortDoctor').value||"";
  let list = doctors.filter(doc => {
    let matches = true;
    if(searchVal) {
      let haystack = [doc.name, doc.degrees, ...doc.specialties, doc.hospital].join(' ').toLowerCase();
      matches = haystack.includes(searchVal);
    }
    if(matches && specialtyVal)
      matches = doc.specialties.some(s=>s===specialtyVal);
    if(matches && hospVal)
      matches = doc.hospital===hospVal;
    return matches;
  });
  if(sortVal==="fee")     list.sort((a,b)=>a.fee-b.fee);
  if(sortVal==="exp")     list.sort((a,b)=>b.experienceYears-a.experienceYears);
  if(sortVal==="rating")  list.sort((a,b)=>b.rating-a.rating);
  const container = userView ? document.getElementById('doctorListUser') : document.getElementById('doctorListPublic');
  container.innerHTML = '';
  list.forEach((doc,i)=>{
    let badgesHTML = doc.specialties.map(s=>
      `<span class="badge ${badgeFor(s)}">${s}</span>`).join('');
    let feeText = `৳${doc.fee}`;
    if(doc.oldFee && doc.oldFee > doc.fee)
      feeText = `<span style="text-decoration:line-through; color:grey;">৳${doc.oldFee}</span> <span class="doc-fee">৳${doc.fee}</span>`;
    container.innerHTML += `
      <div class="doctor-card">
        ${docAvatar(i,doc.name)}
        <div class="doc-info">
          <div class="doc-name">${doc.name}</div>
          <div class="doc-degrees">${doc.degrees}</div>
          ${badgesHTML}
          <div class="doc-row"><span class="doc-hospital">${doc.hospital}</span></div>
          <div class="doc-row">
            <span class="doc-exp">${doc.experienceYears}+ Years</span>
            <span class="doc-rating">★ ${doc.rating} (${doc.ratingsCount})</span>
          </div>
          <div class="doc-row"><span class="doc-fee">Fee: ${feeText}</span> <span class="muted">(Inc. VAT)</span></div>
          <div class="actions">
            <button onclick="startBooking('${doc.id}')">Appointment</button>
          </div>
        </div>
      </div>
    `;
  });
  if(list.length===0){
    container.innerHTML = `<div class="small-muted" style="margin-top:12px">No doctors found.</div>`;
  }
}
function startBooking(docId){
  if(!currentUser){
    intendedDoctor = docId;
    showScreen('loginScreen');
    return;
  }
  openBookingForDoctor(docId);
}
function openBookingForDoctor(docId){
  bookingState = {doctorId: docId, selectedDate: null, selectedTime: null};
  renderBookingDocCard(docId);
  initCalendar(); renderTimeSlots(); hidePatientForm();
  showScreen('bookingScreen');
}
function renderBookingDocCard(docId) {
  const doc = getDoctorById(docId);
  let badgesHTML = doc.specialties.map(s=>`<span class="badge ${badgeFor(s)}">${s}</span>`).join('');
  let feeText = `৳${doc.fee}`;
  if(doc.oldFee && doc.oldFee > doc.fee)
    feeText = `<span style="text-decoration:line-through; color:grey;">৳${doc.oldFee}</span> <span class="doc-fee">৳${doc.fee}</span>`;
  document.getElementById('bookingDocBox').innerHTML =
    `<div class="doctor-card" style="padding:6px;">
      ${docAvatar(doctors.findIndex(x=>x.id===docId),doc.name)}
      <div class="doc-info">
        <div class="doc-name">${doc.name}</div>
        <div class="doc-degrees">${doc.degrees}</div>
        ${badgesHTML}
        <div class="doc-row"><span class="doc-hospital">${doc.hospital}</span></div>
        <div class="doc-row">
          <span class="doc-exp">${doc.experienceYears}+ Years</span>
          <span class="doc-rating">★ ${doc.rating} (${doc.ratingsCount})</span>
        </div>
        <div class="doc-row"><span class="doc-fee">Fee: ${feeText}</span></div>
      </div>
    </div>`;
  document.getElementById('bookingTitle').textContent = `Book — ${doc.name}`;
}

// --- Slots between 5PM & 10PM ---
function generateSlots(){
  const startMin = 17*60;
  const endMin = 22*60;
  const interval = 15;
  const slots = [];
  for(let m=startMin; m<endMin; m+=interval){ slots.push(minutesToTime(m)); }
  return slots;
}

// --- Calendar showing doc's off-day ---
function initCalendar(){
  const grid = document.getElementById('calGrid');
  const title = document.getElementById('calTitle');
  grid.innerHTML = '';
  title.textContent = `${calStart.toLocaleString(undefined,{month:'short'})} ${calStart.getFullYear()}`;
  let doc = getDoctorById(bookingState.doctorId);
  for(let i=0;i<30;i++){
    const d = new Date(calStart); d.setDate(calStart.getDate()+i);
    const iso = fmtDateISO(d);
    const dayDiv = document.createElement('div');
    dayDiv.className = 'cal-day';
    dayDiv.textContent = `${d.getDate()}`;
    if(d.getDay() === doc.offDay){
      dayDiv.classList.add('off');
      dayDiv.title = "Doctor's weekly off-day";
    } else if(d < new Date(today.getFullYear(), today.getMonth(), today.getDate())){
      dayDiv.classList.add('disabled');
    } else {
      dayDiv.onclick = ()=> selectDate(iso, dayDiv);
    }
    grid.appendChild(dayDiv);
  }
}
// --- Slot rendering: disable breaks ---
function isBreakSlot(doc, time){
  for(const br of doc.breaks){
    if(time >= br.start && time < br.end) return true;
  }
  return false;
}
function renderTimeSlots(){
  const container = document.getElementById('timeSlots');
  container.innerHTML = '';
  const slots = generateSlots();
  if(!bookingState.selectedDate){
    container.innerHTML = `<div class="small-muted">Select a date to see available time slots</div>`;
    return;
  }
  const doc = getDoctorById(bookingState.doctorId);
  const dt = new Date(bookingState.selectedDate);
  if(dt.getDay() === doc.offDay){
    container.innerHTML = `<span style="color:#e8590c;font-weight:600;">No appointments: Weekly off-day.</span>`;
    return;
  }
  slots.forEach(t=>{
    const btn = document.createElement('div');
    btn.className = 'slot';
    if(isBreakSlot(doc, t)){
      btn.classList.add('break');
      btn.title = "Doctor's break";
      btn.textContent = shortTime(t) + " (Break)";
    } else if(isSlotTaken(doc.id, bookingState.selectedDate, t)){
      btn.classList.add('taken');
      btn.textContent = shortTime(t);
    } else {
      btn.onclick = ()=> selectSlot(t, btn);
      btn.textContent = shortTime(t);
    }
    if(bookingState.selectedTime === t) btn.classList.add('selected');
    container.appendChild(btn);
  });
}
function isSlotTaken(doctorId, date, time){
  return appointments.some(a => a.doctorId===doctorId && a.date===date && a.time===time);
}
function selectDate(iso, el){
  document.querySelectorAll('#calGrid .cal-day').forEach(d=>d.classList.remove('selected'));
  el.classList.add('selected');
  bookingState.selectedDate = iso;
  renderTimeSlots();
}
function selectSlot(time, el){
  document.querySelectorAll('.slot').forEach(s=>s.classList.remove('selected'));
  el.classList.add('selected');
  bookingState.selectedTime = time;
  showPatientForm();
}
function showPatientForm(){
  document.getElementById('patientFormWrap').style.display = 'block';
  document.getElementById('isPatientYou').checked = true;
  togglePatientSelf();
  clearPatientFormErrors();
  updateFeeDisplay();
}
function hidePatientForm(){
  document.getElementById('patientFormWrap').style.display = 'none';
}
function cancelPatientForm(){
  bookingState.selectedTime = null;
  document.querySelectorAll('.slot').forEach(s=>s.classList.remove('selected'));
  hidePatientForm();
}
function togglePatientSelf(){
  const isYou = document.getElementById('isPatientYou').checked;
  if(isYou && currentUser){
    document.getElementById('patientName').value = currentUser.name || "";
    document.getElementById('patientPhone').value = currentUser.phone || "";
    document.getElementById('patientRelation').value = "Self";
    document.getElementById('patientName').disabled = true;
    document.getElementById('patientPhone').disabled = !!currentUser.phone ? true : false;
    document.getElementById('patientRelation').disabled = true;
  } else {
    document.getElementById('patientName').disabled = false;
    document.getElementById('patientPhone').disabled = false;
    document.getElementById('patientRelation').disabled = false;
    if(!isYou){
      document.getElementById('patientName').value = "";
      document.getElementById('patientRelation').value = "";
      document.getElementById('patientPhone').value = "";
    }
  }
  updateFeeDisplay();
}
function clearPatientFormErrors(){
  ['errPatientName','errPatientRelation','errPatientPhone'].forEach(id=>{document.getElementById(id).textContent="";});
}
function updateFeeDisplay(){
  if(!bookingState.doctorId) return;
  let patientName = document.getElementById('patientName').value.trim() || "";
  let showReports = document.getElementById('showReportsOnly').checked;
  let docFee = calculateFee(bookingState.doctorId, patientName, showReports);
  let displayText = "Expected Fee: <span class='doc-fee'>৳"+docFee+"</span> (Inc. VAT)";
  let repeatCount = (patientName && appointments.filter(a=>a.doctorId===bookingState.doctorId && a.patientName===patientName).length) || 0;
  if(repeatCount>0 && !showReports) displayText += "<br/><span class='muted'>Repeat visit discount applied (-200৳).</span>";
  if(showReports) displayText += "<br/><span class='muted'>Test report only: fee reduced to 30%.</span>";
  document.getElementById('selectedFeeDisplay').innerHTML = displayText;
}
function calculateFee(doctorId, patientName, showReportsOnly) {
  let baseFee = getDoctorFee(doctorId);
  let fee = baseFee;
  let repeatVisits = patientName ? appointments.filter(a=>a.doctorId === doctorId && a.patientName === patientName).length : 0;
  if(repeatVisits > 0) fee -= 200;
  if(showReportsOnly) fee = Math.round(fee * 0.3);
  return Math.max(fee, 0);
}
function confirmBooking(){
  clearPatientFormErrors();
  let ok = true;
  if(!bookingState.selectedDate || !bookingState.selectedTime){
    alert("Select a date and time first."); return;
  }
  const patientName = document.getElementById('patientName').value.trim();
  const relation = document.getElementById('patientRelation').value.trim();
  const phone = document.getElementById('patientPhone').value.trim();
  const showReportsOnly = document.getElementById('showReportsOnly').checked;
  if(!patientName){ document.getElementById('errPatientName').textContent="Patient name required."; ok=false;}
  if(!relation){ document.getElementById('errPatientRelation').textContent="Relation required."; ok=false;}
  if(!phone.match(/^\d{7,}$/)){
    document.getElementById('errPatientPhone').textContent="Valid phone required."; ok=false;
  }
  if(!ok) return;
  if(isSlotTaken(bookingState.doctorId, bookingState.selectedDate, bookingState.selectedTime)){
    alert("Sorry that slot was just taken. Choose another.");
    renderTimeSlots(); hidePatientForm(); return;
  }
  const feePaid = calculateFee(bookingState.doctorId, patientName, showReportsOnly);
  const id = 'a'+Math.random().toString(36).slice(2,9);
  appointments.push({
    id, doctorId: bookingState.doctorId, date: bookingState.selectedDate, time: bookingState.selectedTime,
    patientName, relation, phone, showReportsOnly,
    fee: feePaid,
    bookedByEmail: currentUser.email
  });
  try{ localStorage.setItem("appointments",JSON.stringify(appointments)); }catch{}
  alert("Appointment confirmed!");
  showDashboard();
}
// ---- Appointment history in dashboard ----
function renderDashboardAppointments(){
  const list = document.getElementById('appointmentsList');
  list.innerHTML = '';
  const userAppts = appointments.filter(a=>a.bookedByEmail === currentUser.email);
  if(userAppts.length===0){
    list.innerHTML = `<div class="small-muted" style="margin-top:8px">No appointments yet.</div>`;
    return;
  }
  userAppts.sort((a,b)=> (a.date > b.date) ? 1 : -1);
  userAppts.forEach(a=>{
    const doc = doctors.find(d=>d.id===a.doctorId) || {};
    let badgesHTML = doc.specialties ? doc.specialties.map(s=>`<span class="badge ${badgeFor(s)} appt-badge">${s}</span>`).join('') : "";
    list.innerHTML += `
      <div class="appt-item">
        <div class="appt-doc-card">
          <div class="appt-doc-photo ${avatarClass[doctors.findIndex(x=>x.id===a.doctorId)%3]}">${docInitials(doc.name||"")}</div>
          <div class="appt-info">
            <div style="font-weight:700">${doc.name || ""}</div>
            <div class="muted">${doc.degrees||""}</div>
            <div>${badgesHTML}</div>
            <div class="muted">${doc.hospital||""}</div>
            <div class="appt-meta">${doc.experienceYears || ""} yrs &middot; ★${doc.rating||""} (${doc.ratingsCount||""})</div>
            <div class="appt-fee">Paid: ৳${a.fee}</div>
          </div>
        </div>
        <div class="muted">Date: ${fmtDateNice(a.date)}, at <b>${shortTime(a.time)}</b></div>
        <div class="muted">Patient: ${a.patientName} &middot; ${a.relation} &middot; ${a.phone}</div>
        ${a.showReportsOnly ? `<div class="small-muted" style="color:#228be6;">This visit is only for showing test reports (fee reduced)</div>` : ''}
      </div>
    `;
  });
}
function clearRegErrors(){
  ["regNameErr","regEmailErr","regPhoneErr","regDobErr","regPassErr","regPass2Err"].forEach(id=>{document.getElementById(id).textContent="";});
}
function register(){
  clearRegErrors();
  const name = document.getElementById('regName').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const phone = document.getElementById('regPhone').value.trim();
  const dob = document.getElementById('regDob').value;
  const pass = document.getElementById('regPass').value;
  const pass2 = document.getElementById('regPass2').value;
  let ok = true;
  if(!name) {document.getElementById('regNameErr').textContent="Name required."; ok=false;}
  if(!email.match(/^[^@]+@[^@]+\.[^@]+$/)){document.getElementById('regEmailErr').textContent="Valid email required.";ok=false;}
  if(!phone.match(/^\d{7,}$/)){document.getElementById('regPhoneErr').textContent="Valid phone required.";ok=false;}
  if(!dob) {document.getElementById('regDobErr').textContent="DOB required.";ok=false;}
  if(pass.length<5){document.getElementById('regPassErr').textContent="Password too short.";ok=false;}
  if(pass !== pass2){document.getElementById('regPass2Err').textContent="Passwords don't match."; ok=false;}
  if(!ok) return;
  if(demoUsers.some(u=>u.email===email)){
    document.getElementById('regEmailErr').textContent="Email already registered."; return;
  }
  const user = {name,email,dob,phone,pass};
  demoUsers.push(user);
  try{ localStorage.setItem("demoUsers",JSON.stringify(demoUsers));}catch{}
  currentUser = {...user};
  intendedDoctor && openBookingForDoctor(intendedDoctor);
  intendedDoctor = null;
  showDashboard();
}
function clearLoginErrors(){
  ["loginEmailErr","loginPassErr"].forEach(id=>{document.getElementById(id).textContent="";});
}
function login(){
  clearLoginErrors();
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPassword').value;
  let ok = true;
  if(!email.match(/^[^@]+@[^@]+\.[^@]+$/)){
    document.getElementById('loginEmailErr').textContent="Valid email required.";ok=false;
  }
  if(!pass){document.getElementById('loginPassErr').textContent="Password required.";ok=false;}
  if(!ok) return;
  const user = demoUsers.find(u=>u.email===email && u.pass===pass);
  if(!user){
    currentUser = { name: "Demo User", email, dob: "1990-01-01", phone: ""};
  } else {
    currentUser = {...user};
  }
  if(intendedDoctor){ openBookingForDoctor(intendedDoctor); intendedDoctor=null; return;}
  showDashboard();
}
function logout(){
  if(!confirm("Logout from this demo session?")) return;
  currentUser = null;
  showScreen('publicDashboard');
  renderDoctorList(false);
}
function showDashboard(){
  document.getElementById('dashUserName').textContent = currentUser.name || "User";
  document.getElementById('userNameShow').textContent = currentUser.name || "";
  document.getElementById('userEmailShow').textContent = currentUser.email || "";
  document.getElementById('userPhoneShow').textContent = currentUser.phone||"";
  document.getElementById('userDobShow').textContent = currentUser.dob || "";
  showScreen('userDashboard');
  renderDoctorList(true);
  renderDashboardAppointments();
}
function cancelBooking(){
  bookingState = {doctorId:null, selectedDate:null, selectedTime:null};
  hidePatientForm(); showDashboard();
}
(function init(){ calStart = new Date(today); renderDoctorList(false); })();
</script>
</body>
</html>
